---
title: "Simulations and resampling methods"
format:
  html:
    toc: true
    toc-location: right
execute:
  echo: false
  fig-width: 6
  fig-asp: 0.6
  out-width: "90%"
---



## Overview

In this, we will cover basic simulations, bootstrapping, permutation tests, and speeding up code through vectorization and parallelization.


::: {.panel-tabset .panel-pills}

### Slide Deck: Simulations

[![](./slides/topic_simulations/preview_simulation.png){width=70%}](./slides/topic_simulations/s_simulations.pdf)

**Simulation studies**  
[Download slides (PDF)](./slides/topic_simulations/s_simulations.pdf)


***

### Slide Deck: Bootstrap

[![](./slides/topic_simulations/preview_bootstrap.png){width=70%}](./slides/topic_reproducible_computing/s_bootstrap.pdf)

**Resampling Methods**  
[Download slides (PDF)](./slides/topic_simulations/s_bootstrap.pdf)


***
### Lab: simulations


**Simulation study workflow**

First, use ADEMP guidelines to define the following

- Simulation scenarios
- Estimands/targets
- Performance measures

Then, for a given simulation scenario follow the basic steps:

1. Choose $n_{sim}$
2. Simulate data
3. Apply method(s)
4. Calculate estimates
5. Store results


Whenever possible, separate scripts for performing different tasks.

#### Simulation exercise: linear regression


Our goal in this exercise will be to plan a well-organized simulation study for multiple linear regression. It will be similar in structure to your Homework 2. Below is a multiple linear regression model, where we are interested in primarily treatment effect.



$$Y_i = \beta_0 + \beta_{treatment}X_{i1} + \mathbf{Z_i}^T\boldsymbol{\gamma} + \epsilon_i$$

- $Y_i$: continuous outcome
- $X_{i1}$: treatment group indicator; $X_{i1}=1$ for treated 
- $\mathbf{Z_i}$: vector of potential confounders

<br>


- $\beta_{treatment}$: average treatment effect, adjusting for $\mathbf{Z_i}$
- $\boldsymbol{\gamma}$: vector of regression coefficient values for confounders 
- $\epsilon_i$: iid error, $\sim N(0, \sigma^2)$


In our simulation, we want to 

- Estimate $\beta_{treatment}$
  - Evaluate through bias and coverage
- Estimate $\sigma^2$
  - Evaluate through bias

- Evaluate these properties at:
  - Sample size $n \in \{10, 50, 500\}$
  - True values $\beta_{treatment} \in \{0.5, 2\}$
  - True values $\sigma^2 \in \{1, 5\}$

- Assume for now that there are no confounders ($\boldsymbol{\gamma} = 0$)
- Assume $X_{i1} = 1$ with probability 0.5
- Use a full factorial design



#### **Exercise 1**: ADEMP structure

* How many simulation scenarios will you be running?
* What are the estimand(s)
* What method(s) are being evaluated/compared?
* What are the performance measure(s)?

#### **Exercise 2**: nSim

Based on desired coverage of 90\% with Monte Carlo error of no more than 1\%, how many simulations ($n_{sim}$) should we perform for each simulation scenario?




#### **Exercise 3**: implementation


I've created an example project folder for running simulations using similar structure from the project organization lecture. Download it [here](labs/example_simulation.zip). Unzip and save in an organized location- this will become its own `GitHub` repository. 

Next, start implementing your simulation study! Write separate scripts for simulating data, applying the method, and extracting estimates. 


For now, choose **just one simulation scenario** to implement.  If you have time, you can implement others.

#### **Exercise 4**: aggregation

Aggregate simulation results.  Use informative tables and/or figures to summarize results.



### Lab: resampling methods

#### Parametric vs. non-Parametric bootstrap

Take the following problem from the slides:

Suppose we have data from a $N(\mu, \sigma^2)$ distribution, $Y = \{y_1, \ldots, y_n\}$

- Interested in obtaining an estimate of the standard error of the trimmed mean with 10% trimmed from each tail
- To employ the parametric bootstrap, we would start by generating $n$ values from a $N(\hat{\mu}, \hat{\sigma}^2)$
  - $\hat{\mu}, \hat{\sigma}^2$ are the ML estimates
- Then, compute trimmed mean using the simulated sample
  - repeat B = 10000 times


##### Exercise 1

Implement both the parametric and non-parametric bootstrap for the trimmed mean here. Compare standard error estimates. Which do you expect to perform better? How would you evaluate what is "better"?

##### Exercise 2

For the non-parametric bootstrap, construct bootstrap-t confidence intervals for the trimmed mean using B = 1000 for the first level bootstrap and Bt = 500 for the second level bootstrap.

#### Permutation test example

Assume there are two sets of independent normal random variables with the same known variance and different means:

- $X_i \sim N(\mu_1,\sigma^2)$
- $Y_i \sim N(\mu^2, \sigma^2)$

Our goal is to test $H_0: \mu_1 = \mu_2$.  Define test statistic: $t = \bar{X}-\bar{Y}$. Permutation test steps:

1. Randomly shuffle labels of $X$ and $Y$
2. Compute $t^* = \bar{X}^*-\bar{Y}^*$
3. Repeat `nperm` times. Resulting $t^*$ values form the **empirical null distribution** of $t$.
4. To compute p-values calculate $Pr(|t^*|> |t|)$




***
:::
